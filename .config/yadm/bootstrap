#!/usr/bin/env bash

source /etc/yadm/pre-bootstrap || exit $?
source ~/.config/yadm/packages.sh || exit $?
source ~/.config/yadm/bootstrap-utils.sh || exit $?

INSTALLED_PACKAGES=$(pacman -Qq | sort)
DEFINED_PACKAGES=$(echo "$PACKAGES $PKG_PACSTRAP" | xargs -n1 | sort | uniq)
PACKAGES_NOT_INSTALLED=$(comm -13 <(echo "$INSTALLED_PACKAGES") <(echo "$DEFINED_PACKAGES"))

if [ "$PACKAGES_NOT_INSTALLED" != '' ]; then
    echo "Installing missing packages:"
    echo "$PACKAGES_NOT_INSTALLED"
    sudo pacman --noconfirm -S $PACKAGES_NOT_INSTALLED || exit $?
fi

enable_and_start_service NetworkManager.service

enable_and_start_service cronie.service

enable_and_start_service sshd.service

if ($IS_DOCKER_HOST); then
    enable_and_start_service docker.service
    add_user_to_group $USER docker
    docker buildx install
fi

NODE_VERSION=22
if ! command -v node > /dev/null 2>&1 || [ $(node --version | cut -d '.' -f 1) != "v$NODE_VERSION" ]; then
    echo "Installing nodejs using fnm"
    fnm install "v$NODE_VERSION"
    fnm default "v$NODE_VERSION"
fi

if ! command -v sessionizer > /dev/null 2>&1; then
    echo "Installing sessionizer"
    go install github.com/stilesdev/sessionizer@latest
fi

if ! grep "$USER" /etc/passwd | grep "/usr/bin/zsh" > /dev/null; then
    echo "Setting shell to zsh"
    sudo chsh -s /usr/bin/zsh $USER
fi

if [ "$GRAPHICS_VENDOR" = 'none' ]; then
    enable_and_start_service nohang.service
else
    enable_and_start_service nohang-desktop.service

    enable_and_start_service bluetooth.service

    if ($IS_LAPTOP); then
        enable_and_start_service keyd.service

        # TODO: are thermald and tlp still relevant?
        # enable_and_start_service thermald.service
        # enable_and_start_service tlp.service
        # mask_service systemd-rfkill.service
        # mask_service systemd-rfkill.socket
    fi

    enable_and_start_user_service waybar.service

    enable_and_start_user_service hyprpolkitagent.service

    enable_and_start_user_service hyprpaper.service

    enable_and_start_user_service hypridle.service

    if [ $(xdg-mime query default inode/directory) != "thunar.desktop" ]; then
        echo "Configuring thunar as the default file explorer"
        xdg-mime default thunar.desktop inode/directory
    fi

    if [[ ! -d "$HOME/Pictures/Screenshots" ]]; then
        echo "Creating screenshots directory"
        mkdir -p "$HOME/Pictures/Screenshots"
    fi

    gpg_setup "C0AC1B5B" "https://github.com/stilesdev.gpg"

    if [ "$USER" = 'jstiles' ]; then
        enable_and_start_service libvirtd.service
        add_user_to_group $USER libvirt
        # sudo virsh net-start default # TODO: is there a way to check for this without a sudo prompt?
    fi
fi

DOTFILES_ORIGIN="git@github.com:stilesdev/dotfiles.git"
if [ $(yadm remote get-url origin) != "$DOTFILES_ORIGIN" ]; then
    echo "Updating the yadm repo origin URL"
    yadm remote set-url origin "$DOTFILES_ORIGIN"
fi

